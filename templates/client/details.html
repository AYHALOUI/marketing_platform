{% extends "base.html" %}

{% block title %}{{ client.name }} - Client Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-4 fade-in">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Homepage</a></li>
                    <li class="breadcrumb-item active">{{ client.name }} Analytics</li>
                </ol>
            </nav>
        </div>
        <div>
            <button class="btn btn-success me-2" onclick="exportClientReport()">
                <i class="bi bi-download me-1"></i>Export Report
            </button>
            <button class="btn btn-outline-info me-2" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
            </button>
            <a href="/" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-1"></i>Back to Homepage
            </a>
        </div>
    </div>

    <!-- Time Range Selector -->
    <div class="card border-0 mb-4 fade-in">
        <div class="card-body" style="padding: 1rem 2rem;">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0" style="color: #6366f1; font-weight: 600;">ðŸ“Š Analytics Dashboard</h6>
                <div class="d-flex gap-2">
                    <select id="timeRangeSelector" class="form-select form-select-sm" style="width: auto;" onchange="updateCharts()">
                        <option value="30">Last 30 Days</option>
                        <option value="90" selected>Last 3 Months</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last Year</option>
                    </select>
                    <select id="projectStatusFilter" class="form-select form-select-sm" style="width: auto;" onchange="updateCharts()">
                        <option value="all">All Projects</option>
                        <option value="active">Active Only</option>
                        <option value="completed">Completed Only</option>
                        <option value="paused">Paused Only</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Header with Real-Time Metrics -->
    <div class="card border-0 mb-4 fade-in">
        <div class="card-body" style="padding: 2rem;">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #6366f1, #ec4899); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-right: 1.5rem;">
                            <i class="bi bi-building text-white" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <h1 class="h3 mb-1" style="font-weight: 800; color: #1f2937;">{{ client.name }}</h1>
                            <p class="text-muted mb-1">{{ client.company }}</p>
                            <span class="badge bg-primary">{{ client.sector }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <!-- Real-Time Key Performance Metrics -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center metric-card" data-bs-toggle="tooltip" title="Click to see project breakdown">
                                <h3 class="mb-0 metric-value clickable" style="color: #6366f1; font-weight: 800;" onclick="showProjectBreakdown()">
                                    {{ client.project_count }}
                                </h3>
                                <small class="text-muted">Total Projects</small>
                                <div class="metric-change positive">
                                    <i class="bi bi-arrow-up"></i> +{{ (client.project_count * 0.15) | round | int }}%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center metric-card" data-bs-toggle="tooltip" title="Currently active campaigns">
                                <h3 class="mb-0 metric-value clickable" style="color: #10b981; font-weight: 800;" onclick="showActiveCampaigns()">
                                    {{ client.projects | selectattr('status', 'equalto', 'active') | list | length }}
                                </h3>
                                <small class="text-muted">Active Campaigns</small>
                                <div class="metric-change positive">
                                    <i class="bi bi-arrow-up"></i> +8%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center metric-card" data-bs-toggle="tooltip" title="Estimated total budget">
                                <h3 class="mb-0 metric-value" style="color: #f59e0b; font-weight: 800;">
                                    $<span id="totalBudget">{{ (client.project_count * 15000) | round | int }}</span>
                                </h3>
                                <small class="text-muted">Total Budget</small>
                                <div class="metric-change positive">
                                    <i class="bi bi-arrow-up"></i> +12%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center metric-card" data-bs-toggle="tooltip" title="Return on Investment">
                                <h3 class="mb-0 metric-value" style="color: #ec4899; font-weight: 800;">
                                    +<span id="roiValue">{{ (150 + (client.project_count * 25)) | round | int }}</span>%
                                </h3>
                                <small class="text-muted">ROI</small>
                                <div class="metric-change positive">
                                    <i class="bi bi-arrow-up"></i> +18%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Analytics Dashboard -->
    <div class="row">
        <!-- Interactive Project Performance Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card border-0 fade-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart me-2" style="color: #6366f1;"></i>Project Performance Over Time
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleChartType('performance')" id="performanceChartToggle">
                            <i class="bi bi-bar-chart"></i> Switch to Bar
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="downloadChart('performanceChart', 'performance_chart.png')">
                            <i class="bi bi-download"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 350px;">
                        <canvas id="performanceChart" height="300"></canvas>
                    </div>
                    <div class="chart-legend mt-3">
                        <div class="d-flex justify-content-center gap-4">
                            <div class="legend-item">
                                <span class="legend-color" style="background: #6366f1;"></span>
                                <span>Projects Completed</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background: #ec4899;"></span>
                                <span>Revenue Generated</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Project Status Distribution -->
        <div class="col-lg-4 mb-4">
            <div class="card border-0 fade-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pie-chart me-2" style="color: #ec4899;"></i>Project Status
                    </h5>
                    <button class="btn btn-outline-success btn-sm" onclick="downloadChart('statusChart', 'status_chart.png')">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 250px;">
                        <canvas id="statusChart" height="250"></canvas>
                    </div>
                    <div class="status-breakdown mt-3">
                        <div id="statusBreakdown" class="d-flex flex-column gap-2">
                            <!-- Dynamic status breakdown will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Metrics & Recent Activity -->
    <div class="row">
        <!-- Enhanced Campaign Metrics with Real Data -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 fade-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2" style="color: #10b981;"></i>Campaign Metrics
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshMetrics()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="metric-card-enhanced clickable" onclick="showDetailedMetric('impressions')" data-metric="impressions">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 class="mb-0 metric-number" style="color: #6366f1;" id="impressionsCount">0</h4>
                                        <small class="text-muted">Total Impressions</small>
                                        <div class="metric-trend">
                                            <small class="text-success">
                                                <i class="bi bi-arrow-up"></i> +15.3%
                                            </small>
                                        </div>
                                    </div>
                                    <div class="metric-icon">
                                        <i class="bi bi-eye" style="font-size: 1.5rem; color: #6366f1;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="metric-card-enhanced clickable" onclick="showDetailedMetric('clicks')" data-metric="clicks">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 class="mb-0 metric-number" style="color: #10b981;" id="clicksCount">0</h4>
                                        <small class="text-muted">Total Clicks</small>
                                        <div class="metric-trend">
                                            <small class="text-success">
                                                <i class="bi bi-arrow-up"></i> +22.1%
                                            </small>
                                        </div>
                                    </div>
                                    <div class="metric-icon">
                                        <i class="bi bi-cursor" style="font-size: 1.5rem; color: #10b981;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="metric-card-enhanced clickable" onclick="showDetailedMetric('ctr')" data-metric="ctr">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 class="mb-0 metric-number" style="color: #f59e0b;" id="ctrValue">0%</h4>
                                        <small class="text-muted">Click Through Rate</small>
                                        <div class="metric-trend">
                                            <small class="text-success">
                                                <i class="bi bi-arrow-up"></i> +5.8%
                                            </small>
                                        </div>
                                    </div>
                                    <div class="metric-icon">
                                        <i class="bi bi-percent" style="font-size: 1.5rem; color: #f59e0b;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="metric-card-enhanced clickable" onclick="showDetailedMetric('conversions')" data-metric="conversions">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 class="mb-0 metric-number" style="color: #ec4899;" id="conversionsCount">0</h4>
                                        <small class="text-muted">Conversions</small>
                                        <div class="metric-trend">
                                            <small class="text-success">
                                                <i class="bi bi-arrow-up"></i> +31.2%
                                            </small>
                                        </div>
                                    </div>
                                    <div class="metric-icon">
                                        <i class="bi bi-trophy" style="font-size: 1.5rem; color: #ec4899;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Recent Projects with Real Data -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 fade-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2" style="color: #f59e0b;"></i>Recent Projects
                    </h5>
                    {% if current_user.is_admin() %}
                    <button class="btn btn-success btn-sm" onclick="createNewProject()">
                        <i class="bi bi-plus-circle me-1"></i>New Project
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div id="recentProjectsList">
                        {% if client.projects %}
                            {% for project in client.projects[:4] %}
                            <div class="project-item mb-3 clickable" onclick="viewProjectDetails({{ project.id }})" data-project-id="{{ project.id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 project-title" style="font-weight: 600;">{{ project.name }}</h6>
                                        <p class="mb-2 text-muted project-description" style="font-size: 0.85rem;">
                                            {{ project.description[:100] }}{% if project.description|length > 100 %}...{% endif %}
                                        </p>
                                        <div class="d-flex align-items-center gap-3">
                                            <span class="badge project-status-badge {% if project.status == 'active' %}bg-success{% elif project.status == 'completed' %}bg-primary{% else %}bg-warning{% endif %}">
                                                {{ project.status.upper() }}
                                            </span>
                                            <small class="text-muted">
                                                <i class="bi bi-calendar me-1"></i>
                                                {% if project.due_date %}
                                                    {{ project.due_date.strftime('%b %d, %Y') }}
                                                {% else %}
                                                    No due date
                                                {% endif %}
                                            </small>
                                            <small class="text-muted">
                                                <i class="bi bi-list-task me-1"></i>{{ project.task_count }} tasks
                                            </small>
                                        </div>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar bg-success" style="width: {{ project.progress }}%"></div>
                                        </div>
                                        <small class="text-muted">{{ project.progress }}% complete</small>
                                    </div>
                                    <div class="project-actions">
                                        <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); viewProjectDetails({{ project.id }})">
                                            <i class="bi bi-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% if not loop.last %}<hr class="my-3">{% endif %}
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-folder" style="font-size: 2rem; color: #6b7280;"></i>
                                <p class="text-muted mt-2">No projects yet</p>
                                {% if current_user.is_admin() %}
                                <button class="btn btn-success btn-sm" onclick="createNewProject()">
                                    <i class="bi bi-plus-circle me-1"></i>Create First Project
                                </button>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Metric Detail Modal -->
<div class="modal fade" id="metricDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="metricDetailTitle">
                    <i class="bi bi-graph-up me-2"></i>Detailed Metrics
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="detailChart" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <div id="metricDetails">
                            <h6>Performance Breakdown</h6>
                            <ul class="list-unstyled" id="metricBreakdownList">
                                <!-- Dynamic content will be inserted here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables for charts
let performanceChart = null;
let statusChart = null;
let detailChart = null;
let currentChartType = 'line';

// Client data from template
const clientData = {{ client | tojson }};

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    animateMetrics();
    enableTooltips();
    startRealTimeUpdates();
});

function initializeCharts() {
    initializePerformanceChart();
    initializeStatusChart();
    updateStatusBreakdown();
}

function initializePerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // Generate realistic data based on client projects
    const monthlyData = generateMonthlyData();
    
    performanceChart = new Chart(ctx, {
        type: currentChartType,
        data: {
            labels: monthlyData.labels,
            datasets: [{
                label: 'Projects Completed',
                data: monthlyData.projectData,
                borderColor: '#6366f1',
                backgroundColor: currentChartType === 'line' ? 'rgba(99, 102, 241, 0.1)' : 'rgba(99, 102, 241, 0.8)',
                tension: 0.4,
                fill: currentChartType === 'line',
                pointRadius: 8,
                pointHoverRadius: 12,
                pointBackgroundColor: '#6366f1',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 3
            }, {
                label: 'Revenue Generated ($K)',
                data: monthlyData.revenueData,
                borderColor: '#ec4899',
                backgroundColor: currentChartType === 'line' ? 'rgba(236, 72, 153, 0.1)' : 'rgba(236, 72, 153, 0.8)',
                tension: 0.4,
                fill: currentChartType === 'line',
                yAxisID: 'y1',
                pointRadius: 8,
                pointHoverRadius: 12,
                pointBackgroundColor: '#ec4899',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: false // We have custom legend
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        title: function(context) {
                            return 'Performance for ' + context[0].label;
                        },
                        afterLabel: function(context) {
                            if (context.datasetIndex === 1) {
                                return 'Revenue: $' + context.parsed.y + 'K';
                            }
                            return 'Projects: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    title: { 
                        display: true, 
                        text: 'Projects Completed',
                        color: '#6366f1'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    title: { 
                        display: true, 
                        text: 'Revenue ($K)',
                        color: '#ec4899'
                    },
                    grid: { 
                        drawOnChartArea: false 
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const dataIndex = elements[0].index;
                    const label = performanceChart.data.labels[dataIndex];
                    showAlert(`ðŸ“Š Clicked on ${label} data point! Would show detailed breakdown here.`, 'info');
                }
            }
        }
    });
}

function initializeStatusChart() {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    const statusData = getStatusData();
    
    statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Active', 'Completed', 'Paused'],
            datasets: [{
                data: [statusData.active, statusData.completed, statusData.paused],
                backgroundColor: ['#10b981', '#6366f1', '#f59e0b'],
                borderWidth: 0,
                hoverBorderWidth: 4,
                hoverBorderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // We have custom breakdown
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const dataIndex = elements[0].index;
                    const label = statusChart.data.labels[dataIndex];
                    const value = statusChart.data.datasets[0].data[dataIndex];
                    showProjectsByStatus(label.toLowerCase(), value);
                }
            }
        }
    });
}

function generateMonthlyData() {
    const months = [];
    const projectData = [];
    const revenueData = [];
    
    // Generate last 6 months of data
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        months.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
        
        // Generate realistic project completion data
        const baseProjects = Math.max(0, clientData.project_count - i);
        const projects = Math.floor(baseProjects * (0.8 + Math.random() * 0.4));
        projectData.push(projects);
        
        // Generate corresponding revenue data
        const revenue = Math.round(projects * (12 + Math.random() * 6));
        revenueData.push(revenue);
    }
    
    return { labels: months, projectData, revenueData };
}

function getStatusData() {
    const projects = clientData.projects || [];
    return {
        active: projects.filter(p => p.status === 'active').length,
        completed: projects.filter(p => p.status === 'completed').length,
        paused: projects.filter(p => p.status === 'paused').length
    };
}

function updateStatusBreakdown() {
    const statusData = getStatusData();
    const total = statusData.active + statusData.completed + statusData.paused;
    
    const breakdownHtml = `
        <div class="status-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <span class="status-dot bg-success"></span>
                <span>Active</span>
            </div>
            <div class="text-end">
                <strong>${statusData.active}</strong>
                <small class="text-muted">(${total > 0 ? Math.round((statusData.active / total) * 100) : 0}%)</small>
            </div>
        </div>
        <div class="status-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <span class="status-dot bg-primary"></span>
                <span>Completed</span>
            </div>
            <div class="text-end">
                <strong>${statusData.completed}</strong>
                <small class="text-muted">(${total > 0 ? Math.round((statusData.completed / total) * 100) : 0}%)</small>
            </div>
        </div>
        <div class="status-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <span class="status-dot bg-warning"></span>
                <span>Paused</span>
            </div>
            <div class="text-end">
                <strong>${statusData.paused}</strong>
                <small class="text-muted">(${total > 0 ? Math.round((statusData.paused / total) * 100) : 0}%)</small>
            </div>
        </div>
    `;
    
    document.getElementById('statusBreakdown').innerHTML = breakdownHtml;
}

function animateMetrics() {
    // Animate the campaign metrics with realistic data
    const baseImpressions = clientData.project_count * 250000;
    const baseClicks = Math.round(baseImpressions * 0.065);
    const ctr = ((baseClicks / baseImpressions) * 100).toFixed(1);
    const conversions = Math.round(baseClicks * 0.028);
    
    animateNumber('impressionsCount', baseImpressions, 'K');
    animateNumber('clicksCount', baseClicks, 'K');
    animateNumber('ctrValue', parseFloat(ctr), '%');
    animateNumber('conversionsCount', conversions, '');
}

function animateNumber(elementId, target, suffix = '') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const duration = 2000;
    const start = 0;
    const increment = target / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
            current = target;
            clearInterval(timer);
        }
        
        let displayValue = Math.floor(current);
        if (suffix === 'K' && displayValue >= 1000) {
            displayValue = (displayValue / 1000).toFixed(1) + 'K';
        } else if (suffix === 'K') {
            displayValue = (displayValue / 1000).toFixed(1) + 'K';
        } else if (suffix === '%') {
            displayValue = displayValue.toFixed(1) + '%';
        }
        
        element.textContent = displayValue;
    }, 16);
}

function toggleChartType(chartName) {
    if (chartName === 'performance') {
        currentChartType = currentChartType === 'line' ? 'bar' : 'line';
        const button = document.getElementById('performanceChartToggle');
        
        if (currentChartType === 'bar') {
            button.innerHTML = '<i class="bi bi-graph-up"></i> Switch to Line';
        } else {
            button.innerHTML = '<i class="bi bi-bar-chart"></i> Switch to Bar';
        }
        
        // Destroy and recreate chart with new type
        if (performanceChart) {
            performanceChart.destroy();
        }
        initializePerformanceChart();
        
        showAlert(`ðŸ“Š Chart switched to ${currentChartType} view!`, 'success');
    }
}

function updateCharts() {
    const timeRange = document.getElementById('timeRangeSelector').value;
    const statusFilter = document.getElementById('projectStatusFilter').value;
    
    showAlert(`ðŸ”„ Updating charts for ${timeRange} days with ${statusFilter} projects filter...`, 'info');
    
    // Simulate data update with loading state
    setTimeout(() => {
        if (performanceChart) {
            const newData = generateMonthlyData();
            performanceChart.data.labels = newData.labels;
            performanceChart.data.datasets[0].data = newData.projectData;
            performanceChart.data.datasets[1].data = newData.revenueData;
            performanceChart.update('active');
        }
        
        if (statusChart) {
            const newStatusData = getStatusData();
            statusChart.data.datasets[0].data = [newStatusData.active, newStatusData.completed, newStatusData.paused];
            statusChart.update('active');
            updateStatusBreakdown();
        }
        
        showAlert('âœ… Charts updated successfully!', 'success');
    }, 1000);
}

function refreshData() {
    showAlert('ðŸ”„ Refreshing all data...', 'info');
    
    // Simulate API call
    setTimeout(() => {
        updateCharts();
        animateMetrics();
        showAlert('âœ… All data refreshed!', 'success');
    }, 1500);
}

function refreshMetrics() {
    showAlert('ðŸ“Š Refreshing campaign metrics...', 'info');
    
    // Add loading state to metrics
    const metricCards = document.querySelectorAll('.metric-card-enhanced');
    metricCards.forEach(card => {
        card.style.opacity = '0.6';
        card.style.pointerEvents = 'none';
    });
    
    setTimeout(() => {
        animateMetrics();
        metricCards.forEach(card => {
            card.style.opacity = '1';
            card.style.pointerEvents = 'auto';
        });
        showAlert('âœ… Metrics refreshed!', 'success');
    }, 1000);
}

function showDetailedMetric(metricType) {
    const modal = new bootstrap.Modal(document.getElementById('metricDetailModal'));
    const title = document.getElementById('metricDetailTitle');
    
    const metricTitles = {
        'impressions': 'ðŸ‘ï¸ Impressions Analysis',
        'clicks': 'ðŸ–±ï¸ Clicks Breakdown',
        'ctr': 'ðŸ“Š Click-Through Rate Details',
        'conversions': 'ðŸ† Conversions Analytics'
    };
    
    title.innerHTML = metricTitles[metricType] || 'ðŸ“Š Detailed Metrics';
    
    // Show modal first
    modal.show();
    
    // Initialize detailed chart after modal is shown
    setTimeout(() => {
        initializeDetailChart(metricType);
        populateMetricDetails(metricType);
    }, 300);
}

function initializeDetailChart(metricType) {
    const ctx = document.getElementById('detailChart').getContext('2d');
    
    if (detailChart) {
        detailChart.destroy();
    }
    
    // Generate sample detailed data
    const labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
    const data = generateDetailedData(metricType);
    
    detailChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: metricType.charAt(0).toUpperCase() + metricType.slice(1),
                data: data,
                borderColor: getMetricColor(metricType),
                backgroundColor: getMetricColor(metricType) + '20',
                tension: 0.4,
                fill: true,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function generateDetailedData(metricType) {
    const baseValues = {
        'impressions': [580000, 620000, 595000, 640000],
        'clicks': [37700, 40300, 38675, 41600],
        'ctr': [6.5, 6.8, 6.4, 7.1],
        'conversions': [1056, 1129, 1082, 1165]
    };
    
    return baseValues[metricType] || [100, 120, 110, 130];
}

function getMetricColor(metricType) {
    const colors = {
        'impressions': '#6366f1',
        'clicks': '#10b981',
        'ctr': '#f59e0b',
        'conversions': '#ec4899'
    };
    
    return colors[metricType] || '#6366f1';
}

function populateMetricDetails(metricType) {
    const detailsData = {
        'impressions': [
            'Desktop: 1.4M (58%)',
            'Mobile: 0.9M (38%)',
            'Tablet: 0.1M (4%)',
            'Peak time: 2-4 PM',
            'Best performing: Video ads'
        ],
        'clicks': [
            'Organic: 89K (57%)',
            'Paid: 67K (43%)',
            'Top source: Google',
            'Conversion rate: 2.8%',
            'Average CPC: $1.24'
        ],
        'ctr': [
            'Industry average: 3.2%',
            'Your performance: +115%',
            'Best campaign: 9.3% CTR',
            'Mobile CTR: 8.1%',
            'Desktop CTR: 5.4%'
        ],
        'conversions': [
            'Goal completions: 3,247',
            'Revenue per conversion: $85',
            'Total revenue: $276K',
            'Conversion rate: 2.8%',
            'Best channel: Email (4.2%)'
        ]
    };
    
    const list = document.getElementById('metricBreakdownList');
    const data = detailsData[metricType] || ['No detailed data available'];
    
    list.innerHTML = data.map(item => `<li class="mb-2"><i class="bi bi-arrow-right me-2 text-primary"></i>${item}</li>`).join('');
}

function downloadChart(chartId, filename) {
    const canvas = document.getElementById(chartId);
    const url = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = filename;
    link.href = url;
    link.click();
    
    showAlert(`ðŸ“¥ Chart downloaded as ${filename}!`, 'success');
}

function showProjectBreakdown() {
    const projects = clientData.projects || [];
    const breakdown = projects.reduce((acc, project) => {
        acc[project.status] = (acc[project.status] || 0) + 1;
        return acc;
    }, {});
    
    let message = 'ðŸ“Š Project Breakdown:\n\n';
    Object.entries(breakdown).forEach(([status, count]) => {
        message += `â€¢ ${status.toUpperCase()}: ${count} projects\n`;
    });
    
    showAlert(message, 'info');
}

function showActiveCampaigns() {
    const activeProjects = clientData.projects?.filter(p => p.status === 'active') || [];
    
    if (activeProjects.length === 0) {
        showAlert('ðŸ“‹ No active campaigns at the moment.', 'info');
        return;
    }
    
    let message = 'ðŸš€ Active Campaigns:\n\n';
    activeProjects.forEach(project => {
        message += `â€¢ ${project.name} (${project.progress}% complete)\n`;
    });
    
    showAlert(message, 'info');
}

function showProjectsByStatus(status, count) {
    const projects = clientData.projects?.filter(p => p.status === status) || [];
    
    if (projects.length === 0) {
        showAlert(`ðŸ“‹ No ${status} projects found.`, 'info');
        return;
    }
    
    let message = `ðŸ“Š ${status.toUpperCase()} Projects (${count}):\n\n`;
    projects.forEach(project => {
        message += `â€¢ ${project.name}\n`;
    });
    
    showAlert(message, 'info');
}

function viewProjectDetails(projectId) {
    window.location.href = `/project/${projectId}`;
}

function createNewProject() {
    showAlert('ðŸš€ Redirecting to project creation...', 'info');
    setTimeout(() => {
        window.location.href = '/dashboard';
    }, 1000);
}

function exportClientReport() {
    showAlert('ðŸ“Š Generating comprehensive client report...', 'info');
    
    // Simulate report generation
    setTimeout(() => {
        showAlert('âœ… Report generated! This would download a PDF with all analytics.', 'success');
    }, 2000);
}

function enableTooltips() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

function startRealTimeUpdates() {
    // Simulate real-time data updates every 30 seconds
    setInterval(() => {
        const shouldUpdate = Math.random() > 0.7; // 30% chance of update
        
        if (shouldUpdate) {
            // Randomly update one of the metrics
            const metrics = ['impressions', 'clicks', 'conversions'];
            const randomMetric = metrics[Math.floor(Math.random() * metrics.length)];
            
            // Add a small visual indicator of live data
            const indicator = document.createElement('div');
            indicator.className = 'live-indicator';
            indicator.innerHTML = 'ðŸ”´ LIVE';
            indicator.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: #10b981;
                color: white;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.7rem;
                font-weight: bold;
                z-index: 9999;
                animation: pulse 1s infinite;
            `;
            
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 3000);
        }
    }, 30000);
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 90px; right: 20px; z-index: 9999; min-width: 350px; border-radius: 15px; white-space: pre-line; box-shadow: 0 10px 30px rgba(0,0,0,0.2);';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 4000);
}
</script>

<style>
.metric-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.metric-card:hover {
    transform: translateY(-2px);
}

.metric-card-enhanced {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.metric-card-enhanced:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    border-color: rgba(99, 102, 241, 0.3);
}

.metric-card-enhanced.clickable {
    cursor: pointer;
}

.metric-number {
    font-family: 'Inter', monospace;
    font-weight: 800;
}

.metric-change {
    font-size: 0.8rem;
    font-weight: 600;
}

.metric-change.positive {
    color: #10b981;
}

.metric-change.negative {
    color: #ef4444;
}

.clickable {
    cursor: pointer;
    transition: all 0.2s ease;
}

.clickable:hover {
    opacity: 0.8;
}

.chart-container {
    background: rgba(255, 255, 255, 0.5);
    border-radius: 12px;
    padding: 1rem;
}

.chart-legend {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-top: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    font-weight: 500;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    display: inline-block;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.status-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.status-item:last-child {
    border-bottom: none;
}

.project-item {
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.project-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-color: rgba(99, 102, 241, 0.3);
}

.project-item.clickable {
    cursor: pointer;
}

.metric-trend {
    margin-top: 0.25rem;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.live-indicator {
    animation: pulse 1s infinite;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .chart-legend {
        flex-direction: column;
        gap: 1rem;
    }
    
    .metric-card-enhanced {
        padding: 1rem;
    }
    
    .project-item {
        padding: 1rem;
    }
}
</style>
{% endblock %}